<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VueStock - Visualisation 3D du Stock</title>
    <link rel="stylesheet" href="vuestock.css">
    <link rel="stylesheet" href="vuestock1-3d.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- En-tête principal -->
    <header class="main-header">
        <div class="header-left">
            <h1><i class="fas fa-warehouse"></i> VueStock</h1>
            <div class="breadcrumb" id="breadcrumb">
                <span class="breadcrumb-item active" data-view="plan">Plan du stock</span>
            </div>
        </div>

        <div class="header-center">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchArticle" placeholder="Rechercher un article...">
                <button id="btnSearch" class="btn-search">Rechercher</button>
            </div>
        </div>

        <div class="header-right">
            <button id="btnView3D" class="btn btn-secondary">
                <i class="fas fa-cube"></i> Vue 3D
            </button>
            <button id="btnSave" class="btn btn-primary">
                <i class="fas fa-save"></i> Sauvegarder
            </button>
            <button id="btnAddRack" class="btn btn-success">
                <i class="fas fa-plus"></i> Ajouter étagère
            </button>
        </div>
    </header>

    <!-- Conteneur principal -->
    <main class="main-container">
        <!-- Barre latérale gauche - Outils -->
        <aside class="sidebar-left" id="sidebarTools">
            <div class="sidebar-section">
                <h3><i class="fas fa-tools"></i> Outils</h3>
                <div class="toolbox">
                    <button class="tool-btn active" data-tool="select" title="Sélectionner">
                        <i class="fas fa-mouse-pointer"></i>
                    </button>
                    <button class="tool-btn" data-tool="rack" title="Ajouter une étagère">
                        <i class="fas fa-th-large"></i>
                    </button>
                    <button class="tool-btn" data-tool="move" title="Déplacer">
                        <i class="fas fa-arrows-alt"></i>
                    </button>
                    <button class="tool-btn" data-tool="delete" title="Supprimer">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>

            <div class="sidebar-section">
                <h3><i class="fas fa-info-circle"></i> Propriétés</h3>
                <div class="properties-panel" id="propertiesPanel">
                    <p class="no-selection">Sélectionnez un élément pour voir ses propriétés</p>
                </div>
            </div>
        </aside>

        <!-- Zone centrale - Les 3 vues -->
        <section class="view-container">
            <!-- VUE 1 : PLAN DU STOCK (vue du dessus) -->
            <div class="view active" id="viewPlan">
                <div class="view-header">
                    <h2><i class="fas fa-map"></i> Plan du stock</h2>
                    <div class="view-actions">
                        <button class="btn btn-sm" id="btnGridToggle">
                            <i class="fas fa-th"></i> Grille
                        </button>
                        <button class="btn btn-sm" id="btnZoomIn"><i class="fas fa-search-plus"></i></button>
                        <button class="btn btn-sm" id="btnZoomOut"><i class="fas fa-search-minus"></i></button>
                        <button class="btn btn-sm" id="btnZoomReset"><i class="fas fa-expand-arrows-alt"></i></button>
                    </div>
                </div>

                <div class="canvas-container">
                    <canvas id="canvasPlan" width="1200" height="800"></canvas>
                    <div class="canvas-overlay" id="planOverlay">
                        <!-- Les étagères seront dessinées ici -->
                    </div>
                </div>

                <div class="view-footer">
                    <div class="coord-display">
                        Position: <span id="mouseCoords">X: 0, Y: 0</span>
                    </div>
                    <div class="scale-display">
                        Échelle: <span id="scaleDisplay">100%</span>
                    </div>
                </div>
            </div>

            <!-- VUE 2 : VUE FACE ÉTAGÈRE -->
            <div class="view" id="viewRack">
                <div class="view-header">
                    <h2>
                        <i class="fas fa-chevron-left back-btn" id="backToPlan"></i>
                        <i class="fas fa-th-large"></i> Étagère
                        <span id="rackTitle">A</span>
                    </h2>
                    <div class="view-actions">
                        <button class="btn btn-sm btn-success" id="btnAddLevel">
                            <i class="fas fa-plus"></i> Ajouter un étage
                        </button>
                    </div>
                </div>

                <div class="rack-container" id="rackContainer">
                    <!-- Les étages seront générés ici dynamiquement -->
                    <div class="empty-state">
                        <i class="fas fa-th-large fa-3x"></i>
                        <p>Aucun étage configuré</p>
                        <button class="btn btn-primary" id="btnAddFirstLevel">
                            Ajouter le premier étage
                        </button>
                    </div>
                </div>

                <div class="rack-controls">
                    <div class="control-group">
                        <label>Code étagère:</label>
                        <input type="text" id="rackCodeInput" value="A" class="form-control">
                    </div>
                    <div class="control-group">
                        <label>Génération automatique:</label>
                        <button class="btn btn-sm" id="btnAutoLevels">
                            Étages 10 à 50 (pas de 10)
                        </button>
                    </div>
                </div>
            </div>

            <!-- VUE 3 : VUE ÉTAGE (détail emplacements) -->
            <div class="view" id="viewLevel">
                <div class="view-header">
                    <h2>
                        <i class="fas fa-chevron-left back-btn" id="backToRack"></i>
                        <i class="fas fa-layer-group"></i> Étage
                        <span id="levelTitle">10</span> - Étagère
                        <span id="levelRackTitle">A</span>
                    </h2>
                    <div class="view-actions">
                        <button class="btn btn-sm btn-success" id="btnAddSlot">
                            <i class="fas fa-plus"></i> Ajouter emplacement
                        </button>
                    </div>
                </div>

                <div class="level-container" id="levelContainer">
                    <!-- Les emplacements seront générés ici -->
                    <div class="empty-state">
                        <i class="fas fa-box-open fa-3x"></i>
                        <p>Aucun emplacement configuré</p>
                        <button class="btn btn-primary" id="btnAddFirstSlot">
                            Ajouter le premier emplacement
                        </button>
                    </div>
                </div>

                <div class="level-controls">
                    <div class="control-group">
                        <label>Code étage:</label>
                        <input type="text" id="levelCodeInput" value="10" class="form-control">
                    </div>
                    <div class="control-group">
                        <label>Génération automatique:</label>
                        <button class="btn btn-sm" id="btnAutoSlots">
                            Emplacements 10 à 100 (pas de 10)
                        </button>
                    </div>
                    <div class="control-group">
                        <label>Nombre d'emplacements:</label>
                        <input type="number" id="slotCount" value="5" min="1" max="50" class="form-control">
                        <button class="btn btn-sm" id="btnGenerateSlots">Générer</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Barre latérale droite - Articles/Stock -->
        <aside class="sidebar-right" id="sidebarStock">
            <div class="sidebar-section">
                <h3><i class="fas fa-boxes"></i> Articles dans l'emplacement</h3>
                <div class="slot-contents" id="slotContents">
                    <p class="no-selection">Sélectionnez un emplacement</p>
                </div>
            </div>

            <div class="sidebar-section">
                <h3><i class="fas fa-chart-bar"></i> Statistiques</h3>
                <div class="stats-panel">
                    <div class="stat-item">
                        <span class="stat-label">Étagères:</span>
                        <span class="stat-value" id="statRacks">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Étages total:</span>
                        <span class="stat-value" id="statLevels">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Emplacements:</span>
                        <span class="stat-value" id="statSlots">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Taux occupation:</span>
                        <span class="stat-value" id="statOccupation">0%</span>
                    </div>
                </div>
            </div>
        </aside>
    </main>

    <!-- Modals et popups -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="rackModal">
            <div class="modal-header">
                <h3><i class="fas fa-th-large"></i> Configuration étagère</h3>
                <button class="modal-close" id="closeRackModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="rackForm">
                    <div class="form-group">
                        <label for="modalRackCode">Code étagère *</label>
                        <input type="text" id="modalRackCode" required class="form-control" placeholder="A, B, C...">
                    </div>
                    <div class="form-group">
                        <label for="modalRackName">Nom d'affichage</label>
                        <input type="text" id="modalRackName" class="form-control" placeholder="Étagère principale">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="modalRackWidth">Largeur (cases)</label>
                            <input type="number" id="modalRackWidth" value="3" min="1" max="10" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="modalRackDepth">Profondeur (cases)</label>
                            <input type="number" id="modalRackDepth" value="2" min="1" max="10" class="form-control">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="modalRackColor">Couleur</label>
                        <input type="color" id="modalRackColor" value="#4a90e2" class="form-control">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelRackModal">Annuler</button>
                <button class="btn btn-primary" id="saveRackModal">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Notification système -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationText">Sauvegarde réussie</span>
    </div>

    <!-- Loader global -->
    <div class="loader-overlay" id="loaderOverlay">
        <div class="loader">
            <div class="loader-spinner"></div>
            <p>Chargement...</p>
        </div>
    </div>

    <!-- Modal Vue 3D -->
    <div class="modal-3d-overlay" id="modal3D">
        <button class="close-3d-btn" id="close3DBtn" title="Fermer">&times;</button>

        <div class="view-3d-container">
            <canvas id="canvas3D"></canvas>

            <!-- ✅ AJOUTEZ ICI le HUD (juste après le canvas) -->
            <div class="vuestock3d-hud">
                <div class="hud-position">
                    <span class="hud-label">Position:</span>
                    <span class="hud-value" id="hud-position">0, 0</span>
                </div>
                <div class="hud-mode">
                    <span class="hud-label">Mode:</span>
                    <span class="hud-value" id="hud-mode">Navigation</span>
                </div>
            </div>

            <div class="loading-3d" id="loading3D">
                <div class="spinner-3d"></div>
                <p>Chargement de la vue 3D...</p>
            </div>

            <!-- ... le reste de votre code 3D existant ... -->
            <div class="controls-3d" id="controls3D" style="display: none;">
                <h3><i class="fas fa-sliders-h"></i> Contrôles</h3>

                <!-- ✅ NOUVEAU : Recherche dans la vue 3D -->
                <div class="control-group-3d">
                    <label>Recherche rapide :</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="text" id="search3DInput" placeholder="Article..."
                               style="flex: 1; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px;">
                        <button id="btnSearch3D" style="padding: 5px 10px;">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <div class="control-group-3d">
                    <label>Vue :</label>
                    <button class="view-btn active" data-view="overview">Ensemble</button>
                    <button class="view-btn" data-view="walk">Piéton</button>
                    <button class="view-btn" data-view="top">Dessus</button>
                </div>
                <div class="control-group-3d">
                    <label>Affichage :</label>
                    <button class="display-btn active" data-mode="normal">Normal</button>
                    <button class="display-btn" data-mode="xray">Rayon-X</button>
                    <button class="display-btn" data-mode="heatmap">Chaleur</button>
                </div>
                <div class="control-group-3d">
                    <button id="btn3DScreenshot"><i class="fas fa-camera"></i> Capture</button>
                    <button id="btn3DReset"><i class="fas fa-undo"></i> Reset</button>
                </div>
                <!-- ✅ NOUVEAU : Bouton mode inventaire -->
                <div class="control-group-3d">
                    <button id="btnStartInventory" class="control-group-3d button" style="width: 100%; background: #f39c12; color: white; border: none; padding: 10px;">
                        <i class="fas fa-clipboard-check"></i> Mode Inventaire
                    </button>
                </div>
                <!-- ✅ NOUVEAU : Bouton chemin optimal -->
                <div class="control-group-3d">
                    <button id="btnOptimalPath" class="control-group-3d button" style="width: 100%; background: #2ecc71; color: white; border: none; padding: 10px;">
                        <i class="fas fa-route"></i> Chemin optimal
                    </button>
                </div>
            </div>

            <div class="stats-3d" id="stats3D" style="display: none;">
                <h3><i class="fas fa-chart-bar"></i> Statistiques</h3>
                <div class="stat-3d-item">
                    <span class="stat-3d-label">Étagères :</span>
                    <span class="stat-3d-value" id="stat3DRacks">0</span>
                </div>
                <div class="stat-3d-item">
                    <span class="stat-3d-label">Emplacements :</span>
                    <span class="stat-3d-value" id="stat3DSlots">0</span>
                </div>
                <div class="stat-3d-item">
                    <span class="stat-3d-label">Taux remplissage :</span>
                    <span class="stat-3d-value" id="stat3DFill">0%</span>
                </div>
            </div>

            <!-- ✅ NOUVEAU : Bannière mode inventaire -->
            <div class="inventory-mode-banner" id="inventoryBanner">
                <div class="inventory-banner-left">
                    <div class="inventory-icon">
                        <i class="fas fa-clipboard-check"></i>
                    </div>
                    <div class="inventory-info">
                        <h3>Mode Inventaire Actif</h3>
                        <p>Vérifiez les emplacements un par un</p>
                    </div>
                </div>
                <div class="inventory-progress">
                    <div class="progress-item">
                        <div class="progress-number" id="inventoryChecked">0</div>
                        <div class="progress-label">Vérifiés</div>
                    </div>
                    <div class="progress-item">
                        <div class="progress-number" id="inventoryDiscrepancies">0</div>
                        <div class="progress-label">Écarts</div>
                    </div>
                    <div class="progress-item">
                        <div class="progress-number" id="inventoryProgress">0%</div>
                        <div class="progress-label">Complété</div>
                    </div>
                </div>
                <div class="inventory-actions">
                    <button class="inventory-btn" id="btnExportInventory">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                    <button class="inventory-btn danger" id="btnStopInventory">
                        <i class="fas fa-times"></i> Terminer
                    </button>
                </div>
            </div>

            <!-- ✅ NOUVEAU : Panel inventaire latéral -->
            <div class="inventory-panel" id="inventoryPanel">
                <div class="inventory-panel-header">
                    <h3><i class="fas fa-list-check"></i> Liste des emplacements</h3>
                    <div class="inventory-filters">
                        <button class="filter-chip active" data-filter="all">Tous</button>
                        <button class="filter-chip" data-filter="unchecked">À vérifier</button>
                        <button class="filter-chip" data-filter="checked">Vérifiés</button>
                        <button class="filter-chip" data-filter="discrepancy">Écarts</button>
                    </div>
                </div>
                <div class="inventory-list" id="inventoryList">
                    <!-- Liste dynamique -->
                </div>
            </div>

            <!-- ✅ NOUVEAU : Panel multi-recherche / chemin optimal -->
            <div class="multi-search-panel" id="multiSearchPanel">
                <div class="multi-search-header">
                    <h3><i class="fas fa-route"></i> Chemin optimal</h3>
                    <button class="multi-close-btn" id="closeMultiSearch">&times;</button>
                </div>

                <div class="multi-search-input-group">
                    <input type="text"
                           class="multi-search-input"
                           id="multiSearchInput"
                           placeholder="Nom de l'article...">
                    <button class="multi-add-btn" id="btnAddToPath">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>

                <div class="multi-articles-list" id="multiArticlesList">
                    <!-- Liste dynamique -->
                </div>

                <div class="multi-stats" id="multiStats" style="display: none;">
                    <div class="multi-stat-item">
                        <span class="multi-stat-value" id="multiDistance">0m</span>
                        <span class="multi-stat-label">Distance</span>
                    </div>
                    <div class="multi-stat-item">
                        <span class="multi-stat-value" id="multiTime">0min</span>
                        <span class="multi-stat-label">Temps estimé</span>
                    </div>
                </div>

                <div class="multi-actions">
                    <button class="multi-action-btn primary" id="btnCalculatePath" disabled>
                        <i class="fas fa-map-marked-alt"></i> Calculer le chemin
                    </button>
                    <button class="multi-action-btn secondary" id="btnShowPickingList" disabled>
                        <i class="fas fa-clipboard-list"></i> Liste de picking
                    </button>
                    <button class="multi-action-btn secondary" id="btnClearPath">
                        <i class="fas fa-eraser"></i> Effacer
                    </button>
                </div>
            </div>

            <div class="minimap-3d" id="minimap3D" style="display: none;">
                <h4>Mini-carte</h4>
                <canvas class="minimap-canvas" id="minimapCanvas"></canvas>
            </div>

            <div class="instructions-3d">
                <i class="fas fa-mouse"></i> Clic gauche : Rotation |
                <i class="fas fa-mouse"></i> Clic droit : Pan |
                <i class="fas fa-mouse"></i> Molette : Zoom
            </div>

            <div class="tooltip-3d" id="tooltip3D">
                <!-- Tooltip dynamique -->
            </div>
        </div>
    </div>

    <!-- ✅ NOUVEAU : Modal détail emplacement -->
    <div class="modal-backdrop" id="slotModalBackdrop"></div>
    <div class="slot-detail-modal" id="slotDetailModal">
        <div class="slot-detail-header">
            <div>
                <h3 id="slotModalTitle">Emplacement</h3>
                <div class="slot-detail-code" id="slotModalCode">--</div>
            </div>
            <button class="slot-close-btn" id="closeSlotModal">&times;</button>
        </div>

        <div class="slot-detail-body" id="slotModalBody">
            <!-- Contenu dynamique -->
        </div>

        <div class="slot-detail-footer">
            <button class="footer-btn" id="btnAddArticle">
                <i class="fas fa-plus"></i> Ajouter article
            </button>
            <button class="footer-btn primary" id="btnSaveSlot">
                <i class="fas fa-save"></i> Sauvegarder
            </button>
        </div>
    </div>

    <!-- ✅ NOUVEAU : Modal vérification inventaire -->
    <div class="inventory-check-modal" id="inventoryCheckModal">
        <div class="inventory-check-header">
            <h3>Vérification emplacement</h3>
            <div class="inventory-check-code" id="checkModalCode">--</div>
        </div>
        <div class="inventory-check-body" id="checkModalBody">
            <!-- Contenu dynamique -->
        </div>
        <div class="inventory-check-footer">
            <button class="check-footer-btn secondary" id="btnCancelCheck">
                Annuler
            </button>
            <button class="check-footer-btn success" id="btnConfirmCheck">
                <i class="fas fa-check"></i> Confirmer
            </button>
        </div>
    </div>

    <!-- ✅ NOUVEAU : Modal liste de picking -->
    <div class="picking-list-modal" id="pickingListModal">
        <div class="picking-list-header">
            <h3><i class="fas fa-clipboard-list"></i> Liste de picking optimisée</h3>
            <button class="multi-close-btn" id="closePickingList">&times;</button>
        </div>
        <div class="picking-list-body" id="pickingListBody">
            <!-- Contenu dynamique -->
        </div>
        <div class="picking-list-footer">
            <button class="picking-footer-btn secondary" id="btnClosePickingList">
                Fermer
            </button>
            <button class="picking-footer-btn primary" id="btnExportPickingList">
                <i class="fas fa-file-pdf"></i> Exporter PDF
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="vuestock.js"></script>
    <script src="vuestock1-3d.js"></script>
    <script src="vuestock-fix.js"></script>
</body>
</html>