<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impresión de etiquetas - Gestión Stock</title>
    <link rel="stylesheet" href="impression.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
</head>
<body>
    <!-- Overlay de chargement -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Cargando...</p>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1><i class="fas fa-print"></i> Impresión de etiquetas</h1>
                <div class="header-info">
                    <span class="back-link">
                        <a href="accueil.html">
                            <i class="fas fa-arrow-left"></i> Volver al inicio
                        </a>
                    </span>
                </div>
            </div>
            <div class="header-right">
                <span class="user-info">
                    <i class="fas fa-user"></i>
                    <span id="usernameDisplay">...</span>
                </span>
                <button id="logoutBtn" class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i> Cerrar sesión
                </button>
            </div>
            <button id="resetAppBtn" class="btn-reset" style="margin-left: 10px;">
                <i class="fas fa-redo"></i> Restablecer todo
            </button>
        </header>

        <!-- Contenu principal -->
        <main class="main-content">
            <!-- Section recherche -->
            <section class="search-section">
                <div class="section-header">
                    <h2><i class="fas fa-search"></i> Buscar un artículo</h2>
                    <div class="search-methods">
                        <!-- Exemple dans impression.html -->
                        <div class="search-methods">
                            <button id="scanEtiquetteBtn" class="btn" onclick="openScanModal('etiquette')">
                                <i class="fas fa-camera"></i> Escanear etiqueta
                            </button>
                            <button id="scanInventaireBtn" class="btn" onclick="openScanModal('inventaire')">
                                <i class="fas fa-camera"></i> Escanear inventario
                            </button>
                        </div>
                    </div>
                </div>

                <div class="search-container">
                    <div class="search-tabs">
                        <button class="tab-btn active" data-tab="single">Etiqueta única</button>
                        <button class="tab-btn" data-tab="multiple">Impresión múltiple</button>
                    </div>

                    <!-- Onglet étiquette unique -->
                    <div id="singleTab" class="tab-content active">
                        <div class="search-grid">
                            <div class="search-method">
                                <h3><i class="fas fa-barcode"></i> Por código de barras</h3>
                                <div class="input-group">
                                    <input type="text"
                                           id="barcodeSearch"
                                           placeholder="Escanear o introducir el código de barras"
                                           class="search-input">
                                    <button id="scanBarcodeBtn" class="btn-action" onclick="openScanModal('single')">
                                        <i class="fas fa-camera"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="search-method">
                                <h3><i class="fas fa-hashtag"></i> Por número de artículo</h3>
                                <div class="input-group">
                                    <input type="text"
                                           id="articleNumberSearch"
                                           placeholder="Ej: ART-001"
                                           class="search-input">
                                    <button id="searchNumberBtn" class="btn-action">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="search-method">
                                <h3><i class="fas fa-tag"></i> Por nombre de artículo</h3>
                                <div class="input-group">
                                    <input type="text"
                                           id="articleNameSearch"
                                           placeholder="Nombre del artículo..."
                                           class="search-input">
                                    <button id="searchNameBtn" class="btn-action">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Résultats de recherche -->
                        <div class="search-results" id="searchResults" style="display: none;">
                            <h3><i class="fas fa-list"></i> Resultados</h3>
                            <div class="results-container" id="resultsContainer">
                                <!-- Rempli dynamiquement -->
                            </div>
                        </div>
                    </div>

                    <!-- Onglet impression multiple -->
                    <div id="multipleTab" class="tab-content">
                        <div class="multiple-instructions">
                            <p><i class="fas fa-info-circle"></i>
                                Seleccione varios artículos para imprimir sus etiquetas de una vez.
                            </p>
                        </div>

                        <div class="multiple-search">
                            <input type="text"
                                   id="multipleSearch"
                                   placeholder="Buscar artículos..."
                                   class="search-input-large">
                            <button id="addToPrintListBtn" class="btn-primary">
                                <i class="fas fa-plus"></i> Añadir a la lista
                            </button>
                        </div>

                        <div class="print-list-container">
                            <h3><i class="fas fa-clipboard-list"></i> Lista de impresión</h3>
                            <div class="print-list" id="printList">
                                <div class="empty-list">
                                    <i class="fas fa-tags"></i>
                                    <p>Ningún artículo seleccionado</p>
                                    <small>Añada artículos desde los resultados de búsqueda</small>
                                </div>
                            </div>

                            <div class="list-actions">
                                <button id="clearListBtn" class="btn-secondary">
                                    <i class="fas fa-trash"></i> Vaciar la lista
                                </button>
                                <button id="printListBtn" class="btn-primary">
                                    <i class="fas fa-print"></i> Imprimir la lista
                                </button>
                                <span class="list-count" id="listCount">0 artículos</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section paramètres d'impression -->
            <section class="settings-section">
                <div class="section-header">
                    <h2><i class="fas fa-cog"></i> Configuración de impresión</h2>
                    <div class="preview-toggle">
                        <button id="togglePreviewBtn" class="btn-secondary">
                            <i class="fas fa-eye"></i> Vista previa
                        </button>
                    </div>
                </div>

                <div class="settings-grid">
                    <!-- Format étiquette -->
                    <div class="settings-card">
                        <h3><i class="fas fa-ruler"></i> Formato de etiqueta</h3>
                        <div class="format-options">
                            <div class="format-option" data-format="small">
                                <input type="radio"
                                       id="formatSmall"
                                       name="labelFormat"
                                       value="small"
                                       checked>
                                <label for="formatSmall">
                                    <div class="format-preview small">
                                        <div class="preview-content">
                                            <div class="preview-barcode"></div>
                                            <div class="preview-text">Pequeña</div>
                                        </div>
                                    </div>
                                    <span>Pequeña (40x20mm)</span>
                                    <small>Código de barras + nombre</small>
                                </label>
                            </div>

                            <div class="format-option" data-format="medium">
                                <input type="radio"
                                       id="formatMedium"
                                       name="labelFormat"
                                       value="medium">
                                <label for="formatMedium">
                                    <div class="format-preview medium">
                                        <div class="preview-content">
                                            <div class="preview-barcode"></div>
                                            <div class="preview-text">Mediana</div>
                                            <div class="preview-details"></div>
                                        </div>
                                    </div>
                                    <span>Mediana (60x40mm)</span>
                                    <small>Código de barras + detalles</small>
                                </label>
                            </div>

                            <div class="format-option" data-format="large">
                                <input type="radio"
                                       id="formatLarge"
                                       name="labelFormat"
                                       value="large">
                                <label for="formatLarge">
                                    <div class="format-preview large">
                                        <div class="preview-content">
                                            <div class="preview-barcode"></div>
                                            <div class="preview-text">Grande</div>
                                            <div class="preview-details"></div>
                                            <div class="preview-price"></div>
                                        </div>
                                    </div>
                                    <span>Grande (100x70mm)</span>
                                    <small>Toda la info + precio</small>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Options d'impression -->
                    <div class="settings-card">
                        <h3><i class="fas fa-sliders-h"></i> Opciones de impresión</h3>
                        <div class="print-options">
                            <div class="option-group">
                                <div class="option-item">
                                    <input type="checkbox" id="optionShowPrice" checked>
                                    <label for="optionShowPrice">
                                        <i class="fas fa-euro-sign"></i>
                                        <span>Mostrar el precio</span>
                                    </label>
                                </div>

                                <div class="option-item">
                                    <input type="checkbox" id="optionShowStock" checked>
                                    <label for="optionShowStock">
                                        <i class="fas fa-boxes"></i>
                                        <span>Mostrar el stock</span>
                                    </label>
                                </div>

                                <div class="option-item">
                                    <input type="checkbox" id="optionShowDate">
                                    <label for="optionShowDate">
                                        <i class="fas fa-calendar"></i>
                                        <span>Mostrar la fecha</span>
                                    </label>
                                </div>

                                <div class="option-item">
                                    <input type="checkbox" id="optionShowLocation">
                                    <label for="optionShowLocation">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>Mostrar la ubicación</span>
                                    </label>
                                </div>
                            </div>

                            <div class="option-group">
                                <div class="option-item">
                                    <label for="copiesPerLabel">
                                        <i class="fas fa-copy"></i>
                                        <span>Copias por etiqueta</span>
                                    </label>
                                    <input type="number"
                                           id="copiesPerLabel"
                                           min="1"
                                           max="10"
                                           value="1"
                                           class="form-input-small">
                                </div>

                                <div class="option-item">
                                    <label for="labelOrientation">
                                        <i class="fas fa-sync-alt"></i>
                                        <span>Orientación</span>
                                    </label>
                                    <select id="labelOrientation" class="form-select-small">
                                        <option value="portrait">Vertical</option>
                                        <option value="landscape">Horizontal</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Paramètres avancés -->
                    <div class="settings-card">
                        <h3><i class="fas fa-tools"></i> Configuración avanzada</h3>
                        <div class="advanced-settings">
                            <div class="advanced-group">
                                <label for="barcodeHeight">
                                    <i class="fas fa-arrows-alt-v"></i>
                                    Altura código de barras (mm)
                                </label>
                                <input type="range"
                                       id="barcodeHeight"
                                       min="10"
                                       max="50"
                                       value="25"
                                       class="slider">
                                <span id="barcodeHeightValue">25 mm</span>
                            </div>

                            <div class="advanced-group">
                                <label for="fontSize">
                                    <i class="fas fa-font"></i>
                                    Tamaño de fuente
                                </label>
                                <select id="fontSize" class="form-select-small">
                                    <option value="small">Pequeña</option>
                                    <option value="medium" selected>Mediana</option>
                                    <option value="large">Grande</option>
                                </select>
                            </div>

                            <div class="advanced-group">
                                <label for="marginSize">
                                    <i class="fas fa-border-all"></i>
                                    Margen (mm)
                                </label>
                                <input type="range"
                                       id="marginSize"
                                       min="0"
                                       max="10"
                                       value="2"
                                       class="slider">
                                <span id="marginSizeValue">2 mm</span>
                            </div>

                            <button id="resetSettingsBtn" class="btn-secondary btn-small">
                                <i class="fas fa-redo"></i> Restablecer
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section aperçu -->
            <section class="preview-section" id="previewSection" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-eye"></i> Vista previa de etiquetas</h2>
                    <div class="preview-controls">
                        <button id="previousLabelBtn" class="btn-pagination" disabled>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="preview-counter">
                            Etiqueta <span id="currentPreview">1</span> de <span id="totalPreviews">1</span>
                        </span>
                        <button id="nextLabelBtn" class="btn-pagination">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>

                <div class="preview-container">
                    <div class="preview-area" id="previewArea">
                        <div class="preview-label" id="previewLabel">
                            <div class="label-content">
                                <div class="label-barcode" id="previewBarcode"></div>
                                <div class="label-text">
                                    <div class="label-title" id="previewTitle">Nombre del artículo</div>
                                    <div class="label-details" id="previewDetails">
                                        <span class="detail-item" id="previewNumber">ART-001</span>
                                        <span class="detail-item" id="previewStock">Stock: 50</span>
                                        <span class="detail-item" id="previewPrice">15.99€</span>
                                    </div>
                                    <div class="label-footer" id="previewFooter">
                                        <span id="previewDate">01/01/2024</span>
                                        <span id="previewLocation">Zona A</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="preview-info">
                        <div class="info-card">
                            <h3><i class="fas fa-info-circle"></i> Información</h3>
                            <div class="info-item">
                                <span class="info-label">Formato :</span>
                                <span class="info-value" id="previewFormat">Mediano (60x40mm)</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Orientación :</span>
                                <span class="info-value" id="previewOrientation">Vertical</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Papel estimado :</span>
                                <span class="info-value" id="previewPaper">1 hoja A4</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section actions -->
            <section class="actions-section">
                <div class="actions-grid">
                    <div class="action-card pdf">
                        <div class="action-icon">
                            <i class="fas fa-file-pdf"></i>
                        </div>
                        <div class="action-content">
                            <h3>Generar PDF</h3>
                            <p>Crea un archivo PDF para impresión posterior</p>
                            <button id="generatePdfBtn" class="btn-secondary btn-large" disabled>
                                <i class="fas fa-file-pdf"></i> Generar PDF
                            </button>
                        </div>
                    </div>
                </div>

                <div class="print-summary" id="printSummary" style="display: none;">
                    <h3><i class="fas fa-clipboard-check"></i> Resumen de impresión</h3>
                    <div class="summary-content">
                        <div class="summary-item">
                            <span class="summary-label">Número de etiquetas :</span>
                            <span class="summary-value" id="summaryCount">0</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Número de artículos :</span>
                            <span class="summary-value" id="summaryArticles">0</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Hojas estimadas :</span>
                            <span class="summary-value" id="summarySheets">0</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Costo estimado :</span>
                            <span class="summary-value" id="summaryCost">0.00 €</span>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p>Sistema de gestión de stock • Impresión de etiquetas</p>
        </footer>
    </div>

    <!-- Modal scan -->
    <div id="scanModal" class="modal-overlay" style="display: none;">
        <div class="modal modal-scan">
            <div class="modal-header">
                <h3><i class="fas fa-camera"></i> Escanear código de barras</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="scan-container">
                    <div class="camera-view" id="cameraView">
                        <div class="camera-placeholder">
                            <i class="fas fa-camera"></i>
                            <p>Inicializando cámara...</p>
                        </div>
                        <video id="cameraPreview" autoplay playsinline style="display: none;"></video>
                        <div class="scan-frame"></div>
                    </div>

                    <div class="scan-controls">
                        <button id="startCameraBtn" class="btn-primary">
                            <i class="fas fa-play"></i> Iniciar cámara
                        </button>
                        <button id="stopCameraBtn" class="btn-secondary" style="display: none;">
                            <i class="fas fa-stop"></i> Detener
                        </button>
                        <button id="toggleFlashBtn" class="btn-secondary">
                            <i class="fas fa-bolt"></i> Flash
                        </button>
                    </div>

                    <div class="scan-manual">
                        <h4><i class="fas fa-keyboard"></i> Entrada manual</h4>
                        <input type="text"
                               id="manualBarcodeInput"
                               placeholder="Introduzca el código de barras manualmente"
                               class="search-input">
                        <button id="confirmManualBarcodeBtn" class="btn-primary">
                            <i class="fas fa-check"></i> Validar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Import des scripts -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script type="module" src="impression.js"></script>
</body>
</html>